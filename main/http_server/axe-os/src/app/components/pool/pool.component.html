<form [formGroup]="form" *ngIf="form">
    <div class="card">
        <!-- Pool Mode Selection -->
        <h2>Pool Mode</h2>
        <div class="card mb-4">
            <div class="field grid p-fluid">
                <label htmlFor="poolMode" class="col-12 md:col-2 md:mb-0">
                    <tooltip-text-icon
                        text="Pool Mode"
                        tooltip="Failover: Use secondary pool only when primary fails. Dual Pool: Split hashrate between both pools simultaneously."
                    />
                </label>
                <div class="col-12 md:col-10">
                    <p-dropdown [options]="poolModeOptions" formControlName="poolMode" optionLabel="label" optionValue="value" [style]="{'width':'100%'}"></p-dropdown>
                </div>
            </div>

            <!-- Pool Balance Slider (only shown in Dual Pool mode) -->
            <div *ngIf="isDualPoolMode()" class="field grid p-fluid mt-3">
                <label htmlFor="poolBalance" class="col-12 md:col-2 md:mb-0">
                    <tooltip-text-icon
                        text="Hashrate Split"
                        tooltip="Percentage of hashrate to send to the primary pool. The remaining percentage goes to the secondary pool."
                    />
                </label>
                <div class="col-12 md:col-10">
                    <div class="flex align-items-center gap-3">
                        <span class="text-sm font-medium" style="min-width: 80px;">Primary: {{form.get('poolBalance')?.value}}%</span>
                        <p-slider formControlName="poolBalance" [min]="1" [max]="99" [step]="1" [style]="{'flex-grow': '1', 'min-width': '200px'}"></p-slider>
                        <span class="text-sm font-medium" style="min-width: 100px;">Secondary: {{100 - form.get('poolBalance')?.value}}%</span>
                    </div>
                    <!-- Fallback manual input if slider doesn't work -->
                    <div class="mt-2">
                        <input pInputText type="number" formControlName="poolBalance" [min]="1" [max]="99" style="width: 80px;" class="text-center" />
                        <span class="ml-2 text-sm text-500">% to Primary Pool (1-99)</span>
                    </div>
                </div>
            </div>

            <!-- Dual Pool Mode Info -->
            <div *ngIf="isDualPoolMode()" class="mt-3 p-3 border-round surface-ground">
                <div class="flex align-items-center gap-2">
                    <i class="pi pi-info-circle text-primary"></i>
                    <span class="text-sm">In Dual Pool mode, both pools will be connected simultaneously and hashrate will be split according to the balance setting.</span>
                </div>
            </div>
        </div>

        <ng-container *ngFor="let pool of pools">
            <h2 *ngIf="pool === 'stratum'">Primary Pool Configuration</h2>
            <h2 *ngIf="pool === 'fallbackStratum'" class="mt-5">
                <span *ngIf="isDualPoolMode()">Secondary Pool Configuration</span>
                <span *ngIf="!isDualPoolMode()">Fallback Pool Configuration</span>
            </h2>

            <div class="card">
                <div class="field grid p-fluid">
                    <label [htmlFor]="pool + 'URL'" class="col-12 md:col-2 md:mb-0">Stratum Host</label>
                    <div class="col-12 md:col-10">
                        <input pInputText type="text" [id]="pool + 'URL'" [formControlName]="pool + 'URL'" (change)="onUrlChange(pool)" />
                    </div>
                </div>
                <div class="field grid p-fluid">
                    <label [htmlFor]="pool + 'Port'" class="col-12 md:col-2 md:mb-0">Stratum Port</label>
                    <div class="col-12 md:col-10">
                        <input pInputText [id]="pool + 'Port'" [formControlName]="pool + 'Port'" type="number" />
                    </div>
                </div>
                <div class="field grid p-fluid">
                    <label [htmlFor]="pool + 'User'" class="col-12 md:col-2 md:mb-0">User</label>
                    <div class="col-12 md:col-10">
                        <input pInputText [id]="pool + 'User'" [formControlName]="pool + 'User'" sensitive-data type="text" />
                    </div>
                </div>
                <div class="field grid p-fluid">
                    <label [htmlFor]="pool + 'Password'" class="col-12 md:col-2 md:mb-0">Password</label>
                    <div class="col-12 md:col-10 p-input-icon-right">
                        <i *ngIf="form.get(pool + 'Password')?.dirty" class="pi cursor-pointer"
                        [ngClass]="{'pi-eye': !showPassword[pool], 'pi-eye-slash': showPassword[pool]}"
                        (click)="showPassword[pool] = !showPassword[pool]"></i>
                        <input pInputText [id]="pool + 'Password'" [formControlName]="pool + 'Password'"
                            [type]="showPassword[pool] ? 'text' : 'password'" />
                    </div>
                </div>

                <fieldset class="m-0 p-0 mt-4 border-200 border-bottom-none border-left-none border-right-none">
                    <legend class="p-0 pr-3">
                        <label class="cursor-pointer">
                            <input type="checkbox" hidden (click)="showAdvancedOptions[pool] = !showAdvancedOptions[pool]">
                            <i class="pi pi-angle-{{showAdvancedOptions[pool] ? 'down' : 'right'}} text-sm -ml-1 mr-1"></i>
                            {{showAdvancedOptions[pool] ? 'Hide' : 'Show'}} Advanced Options
                        </label>
                    </legend>

                    <div *ngIf="showAdvancedOptions[pool]" class="field grid p-fluid mt-4">
                        <label [htmlFor]="pool + 'SuggestedDifficulty'" class="col-12 md:col-2 md:mb-0">
                            <tooltip-text-icon
                                text="Suggested Difficulty"
                                tooltip="Used to indicate a preference for share difficulty to the pool. Servers are not required to honour this request, even if they support the stratum method. (0 to disable)"
                            />
                        </label>
                        <div class="col-12 md:col-10">
                            <input pInputText [id]="pool + 'SuggestedDifficulty'" [formControlName]="pool + 'SuggestedDifficulty'" type="number" />
                        </div>
                    </div>
                    <div *ngIf="showAdvancedOptions[pool]" class="field-checkbox grid mb-0">
                        <div class="col-1 md:col-10 md:flex-order-2">
                            <p-checkbox [name]="pool + 'ExtranonceSubscribe'" [inputId]="pool + 'ExtranonceSubscribe'" [formControlName]="pool + 'ExtranonceSubscribe'"
                                [binary]="true"></p-checkbox>
                        </div>
                        <label [htmlFor]="pool + 'ExtranonceSubscribe'" class="col-11 m-0 pl-3 md:col-2 md:flex-order-1 md:p-2">
                            <tooltip-text-icon
                                text="Enable Extranonce Subscribe"
                                tooltip="Indicates to the server that the client supports the mining.set_extranonce method. Required by some pools, check the pool documentation."
                            />
                        </label>
                    </div>
                </fieldset>
            </div>
        </ng-container>

        <div class="flex mt-5 gap-3">
            <button pButton [disabled]="!form.dirty || form.invalid" (click)="updateSystem()"
                class="btn btn-primary">Save</button>
            <button pButton [disabled]="!savedChanges" (click)="restart()">Restart</button>
        </div>
    </div>
</form>
